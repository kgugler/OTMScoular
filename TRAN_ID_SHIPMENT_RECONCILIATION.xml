<?xml version="1.0" encoding="utf-8"?>
<dataTemplate name="TRAN_ID_SHIPMENT_RECONCILIATION" description="Tran ID, Shipment Reconciliation Report" dataSourceRef="ORCL" defaultPackage="" version="1.0">
  <parameters></parameters>
  <lexicals></lexicals>
  <dataQuery>
    <sqlStatement name="Q_ROWS"><![CDATA[SELECT DISTINCT V.*, SSUR.REFNUM_VALUE tran_id
FROM shipment_stop_d SSTOPD
JOIN s_ship_unit_refnum SSUR ON SSTOPD.S_SHIP_UNIT_GID = SSUR.S_SHIP_UNIT_GID
AND SSUR.S_SHIP_UNIT_REFNUM_QUAL_GID IN ('SCOULAR/FOOD.TRUCK ID','SCOULAR/FOOD.RAILCAR ID','SCOULAR/FOOD.TRAIN ID','SCOULAR/FOOD.CONTAINER ID')
CROSS JOIN
(SELECT
    SHIP.SHIPMENT_GID,
    SREF1.SHIPMENT_REFNUM_VALUE loc_code,
    SPROV.SERVPROV_XID serv_prov_id,  
    SHIP.SHIPMENT_XID shipment_id,
    SREF2.SHIPMENT_REFNUM_VALUE charge_type, 
    '$' || REGEXP_REPLACE (TO_CHAR (SHIP.TOTAL_ACTUAL_COST, '999,999,990.99'), '\s*', '') freight_charge
FROM shipment SHIP 
JOIN shipment_refnum SREF1 ON SHIP.SHIPMENT_GID = SREF1.SHIPMENT_GID
JOIN shipment_refnum SREF2 ON SHIP.SHIPMENT_GID = SREF2.SHIPMENT_GID
JOIN servprov SPROV ON SHIP.SERVPROV_GID = SPROV.SERVPROV_GID
WHERE
 SHIP.SHIPMENT_TYPE_GID = 'TRANSPORT'
AND
 SREF1.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.LOC_CODE'
AND
 SREF2.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.CHARGE TYPE'
AND
    NOT EXISTS (SELECT IVSHIP.SHIPMENT_GID
                FROM invoice_shipment IVSHIP
                WHERE IVSHIP.SHIPMENT_GID = SHIP.SHIPMENT_GID)
UNION
SELECT
    SHIP.SHIPMENT_GID,
    SREF1.SHIPMENT_REFNUM_VALUE loc_code,
    SPROV.SERVPROV_XID serv_prov_id,  
    SHIP.SHIPMENT_XID shipment_id,
    SREF2.SHIPMENT_REFNUM_VALUE charge_type, 
    '$' || REGEXP_REPLACE (TO_CHAR (SHIP.TOTAL_ACTUAL_COST, '999,999,990.99'), '\s*', '') freight_charge
FROM shipment SHIP 
JOIN shipment_refnum SREF1 ON SHIP.SHIPMENT_GID = SREF1.SHIPMENT_GID
JOIN shipment_refnum SREF2 ON SHIP.SHIPMENT_GID = SREF2.SHIPMENT_GID
JOIN servprov SPROV ON SHIP.SERVPROV_GID = SPROV.SERVPROV_GID
JOIN invoice_shipment IVSHIP ON SHIP.SHIPMENT_GID = IVSHIP.SHIPMENT_GID
JOIN invoice_status IVSTAT ON IVSHIP.INVOICE_GID = IVSTAT.INVOICE_GID
AND
IVSTAT.STATUS_TYPE_GID = 'SCOULAR/FOOD.APPROVAL'
AND IVSTAT.STATUS_VALUE_GID = 'SCOULAR/FOOD.APPROVAL_APPROVED_MANUAL'
WHERE
 SHIP.SHIPMENT_TYPE_GID = 'TRANSPORT'
AND
 SREF1.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.LOC_CODE'
AND
 SREF2.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.CHARGE TYPE') V
 WHERE
    V.SHIPMENT_GID = SSTOPD.SHIPMENT_GID
 AND
    SSTOPD.STOP_NUM = 1
 ORDER BY V.LOC_CODE,V.SHIPMENT_ID]]></sqlStatement>
    <sqlStatement name="Q_ROW_COUNT"><![CDATA[SELECT COUNT(1) "ROW_COUNT" FROM (SELECT DISTINCT V.*, SSUR.REFNUM_VALUE tran_id
FROM shipment_stop_d SSTOPD
JOIN s_ship_unit_refnum SSUR ON SSTOPD.S_SHIP_UNIT_GID = SSUR.S_SHIP_UNIT_GID
AND SSUR.S_SHIP_UNIT_REFNUM_QUAL_GID IN ('SCOULAR/FOOD.TRUCK ID','SCOULAR/FOOD.RAILCAR ID','SCOULAR/FOOD.TRAIN ID','SCOULAR/FOOD.CONTAINER ID')
CROSS JOIN
(SELECT
    SHIP.SHIPMENT_GID,
    SREF1.SHIPMENT_REFNUM_VALUE loc_code,
    SPROV.SERVPROV_XID serv_prov_id,  
    SHIP.SHIPMENT_XID shipment_id,
    SREF2.SHIPMENT_REFNUM_VALUE charge_type, 
    '$' || REGEXP_REPLACE (TO_CHAR (SHIP.TOTAL_ACTUAL_COST, '999,999,990.99'), '\s*', '') freight_charge
FROM shipment SHIP 
JOIN shipment_refnum SREF1 ON SHIP.SHIPMENT_GID = SREF1.SHIPMENT_GID
JOIN shipment_refnum SREF2 ON SHIP.SHIPMENT_GID = SREF2.SHIPMENT_GID
JOIN servprov SPROV ON SHIP.SERVPROV_GID = SPROV.SERVPROV_GID
WHERE
 SHIP.SHIPMENT_TYPE_GID = 'TRANSPORT'
AND
 SREF1.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.LOC_CODE'
AND
 SREF2.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.CHARGE TYPE'
AND
    NOT EXISTS (SELECT IVSHIP.SHIPMENT_GID
                FROM invoice_shipment IVSHIP
                WHERE IVSHIP.SHIPMENT_GID = SHIP.SHIPMENT_GID)
UNION
SELECT
    SHIP.SHIPMENT_GID,
    SREF1.SHIPMENT_REFNUM_VALUE loc_code,
    SPROV.SERVPROV_XID serv_prov_id,  
    SHIP.SHIPMENT_XID shipment_id,
    SREF2.SHIPMENT_REFNUM_VALUE charge_type, 
    '$' || REGEXP_REPLACE (TO_CHAR (SHIP.TOTAL_ACTUAL_COST, '999,999,990.99'), '\s*', '') freight_charge
FROM shipment SHIP 
JOIN shipment_refnum SREF1 ON SHIP.SHIPMENT_GID = SREF1.SHIPMENT_GID
JOIN shipment_refnum SREF2 ON SHIP.SHIPMENT_GID = SREF2.SHIPMENT_GID
JOIN servprov SPROV ON SHIP.SERVPROV_GID = SPROV.SERVPROV_GID
JOIN invoice_shipment IVSHIP ON SHIP.SHIPMENT_GID = IVSHIP.SHIPMENT_GID
JOIN invoice_status IVSTAT ON IVSHIP.INVOICE_GID = IVSTAT.INVOICE_GID
AND
IVSTAT.STATUS_TYPE_GID = 'SCOULAR/FOOD.APPROVAL'
AND IVSTAT.STATUS_VALUE_GID = 'SCOULAR/FOOD.APPROVAL_APPROVED_MANUAL'
WHERE
 SHIP.SHIPMENT_TYPE_GID = 'TRANSPORT'
AND
 SREF1.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.LOC_CODE'
AND
 SREF2.SHIPMENT_REFNUM_QUAL_GID = 'SCOULAR.CHARGE TYPE') V
 WHERE
    V.SHIPMENT_GID = SSTOPD.SHIPMENT_GID
 AND
    SSTOPD.STOP_NUM = 1
 ORDER BY V.LOC_CODE,V.SHIPMENT_ID)]]></sqlStatement>
  </dataQuery>
  <dataStructure>
    <group name="G_ROWS" source="Q_ROWS">
      <element name="LOC_CODE" value="LOC_CODE" />
      <element name="SERV_PROV_ID" value="SERV_PROV_ID" />
      <element name="TRAN_ID" value="TRAN_ID" />
      <element name="SHIPMENT_ID" value="SHIPMENT_ID" />
      <element name="CHARGE_TYPE" value="CHARGE_TYPE" />
      <element name="FREIGHT_CHARGE" value="FREIGHT_CHARGE" />
    </group>
    <group name="G_ROW_COUNT" source="Q_ROW_COUNT">
      <element name="ROW_COUNT" value="ROW_COUNT" />
    </group>
  </dataStructure>
</dataTemplate>